#!/bin/bash

# Script to fix Perplexity MCP configuration issues
# Forces Claude Code to use only local configuration
# 
# COPY THIS FILE to fix-mcp-config.sh and ensure .env file exists with your API keys
# Run scripts/setup-environment.sh first to create .env from .env.example

set -e

echo "ðŸ”§ Fixing MCP Configuration..."

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Backup any existing global config
if [ -f ~/.config/claude-code/settings.json ]; then
    print_warning "Backing up existing global Claude config..."
    mkdir -p ~/.config/claude-code/backup
    cp ~/.config/claude-code/settings.json ~/.config/claude-code/backup/settings.json.$(date +%Y%m%d_%H%M%S)
    print_status "Backup created"
fi

# Set environment variables to force local config usage
export CLAUDE_MCP_CONFIG="$(pwd)/.mcp.json"
print_status "Set CLAUDE_MCP_CONFIG to: $CLAUDE_MCP_CONFIG"

# Create a clean environment script that sources from .env
cat > set-mcp-env.sh << 'EOF'
#!/bin/bash
# Source this file to set MCP environment variables

# Load environment variables from root .env file
if [ -f "/workspaces/hackathon_demo/.env" ]; then
    export $(cat /workspaces/hackathon_demo/.env | grep -v '^#' | grep -v '^$' | xargs)
    echo "âœ… Loaded environment variables from .env file"
else
    echo "âŒ .env file not found. Run scripts/setup-environment.sh first."
    exit 1
fi

export CLAUDE_MCP_CONFIG="/workspaces/hackathon_demo/mcp-integration/.mcp.json"
echo "âœ… MCP environment variables set"
echo "CLAUDE_MCP_CONFIG: $CLAUDE_MCP_CONFIG"
echo "PERPLEXITY_API_KEY: [HIDDEN]"
EOF

chmod +x set-mcp-env.sh
print_status "Created set-mcp-env.sh script"

# Source the environment
source set-mcp-env.sh

print_status "âœ… Configuration fix complete!"
print_warning "Next steps:"
echo "1. Ensure .env file exists with your API keys (run scripts/setup-environment.sh if needed)"
echo "2. Run: source set-mcp-env.sh (to set environment variables)"
echo "3. Restart Claude Code completely"
echo "4. Test with: /mcp list (if available)"
echo "5. Or test Perplexity MCP functionality directly"